ADR-003 — Backend Login Test Plan (Wallet Authentication)
Status

Proposed → Accepted

Purpose

Define a complete backend test plan for wallet-based authentication, ensuring that:

Login behavior is fully specified by tests

Cryptographic identity verification is reliable

Sessions are securely maintained

The frontend can consume the backend without embedding business or security logic

This ADR defines what must be tested, at which level, and in which order, before frontend development begins.

Scope
In Scope

Signature verification

Challenge-based authentication

JWT session issuance and validation

Login orchestration

Backend APIs related to authentication

Security-related failure cases

Out of Scope (explicit)

Roles and permissions

Orders and workflows

Blockchain adapters

User persistence

CI / deployment

Testing Strategy Overview

The backend authentication system is validated through four testing layers:

Unit Tests
   ↓
Service Integration Tests
   ↓
API Integration Tests
   ↓
Security & Abuse Scenarios


Each layer builds on the previous one.

1️⃣ SignatureService — Unit Tests (Crypto Identity)
Objective

Verify cryptographic identity validation in isolation.

Tests
✅ Accepts valid signature

Given a valid (message, signature, publicKey)

Returns VerifiedSignature

Contains signer and messageHash

❌ Rejects invalid signature

Given an invalid signature

Throws InvalidSignatureError

❌ Rejects altered message

Signature valid for another message

Throws InvalidSignatureError

❌ Rejects mismatched publicKey

Signature does not correspond to provided publicKey

Throws InvalidSignatureError

2️⃣ Challenge Service — Unit Tests (Anti-Replay)
Objective

Ensure backend-generated challenges are secure and single-use.

Tests
✅ Generates unique challenges

Each call returns a different challenge

✅ Challenge contains expiration

Expired challenges are rejected

❌ Rejects reused challenge

Same challenge used twice

Second attempt fails

❌ Rejects unknown challenge

Challenge not generated by backend

Login fails

3️⃣ JwtService — Unit Tests (Session Handling)
Objective

Ensure session tokens represent verified identity only.

Tests
✅ Issues JWT for verified identity

Payload contains wallet publicKey

Contains iat and exp

❌ Does not issue JWT on failure

Signature verification fails

JWT is not generated

❌ Rejects expired JWT

Token past expiration

Authentication fails

4️⃣ LoginService — Unit Tests (Orchestration)
Objective

Define login behavior independent of transport (HTTP).

Tests
✅ Successful login flow

Valid challenge

Valid signature

JWT is returned

❌ Login fails on invalid signature

InvalidSignatureError propagated

No JWT issued

❌ Login fails on invalid challenge

Expired or reused challenge

No JWT issued

5️⃣ LoginService — Integration Tests (No Mocks)
Objective

Validate real interaction between services.

Setup

Real SignatureService

Real JwtService

Real ChallengeService

No mocks between them

Tests
✅ Full login flow

Challenge issued

Signature verified

JWT issued

❌ Full login failure on invalid signature

Signature invalid

Login rejected

❌ Replay attack prevention

Same signature reused

Second attempt rejected

6️⃣ Auth API — Integration Tests (HTTP Level)
Objective

Ensure API behaves correctly for frontend consumption.

Endpoints
GET /auth/challenge

Tests:

Returns challenge

Challenge is unique

Challenge has expiration

POST /auth/login

Tests:

Valid signature → returns JWT

Invalid signature → 401

Invalid challenge → 401

Reused challenge → 401

7️⃣ Security & Abuse Scenarios
Objective

Ensure system fails safely under malicious conditions.

Tests

Stolen signature replay

Signature with altered message

Signature with wrong publicKey

Expired JWT usage

Missing Authorization header

Malformed JWT

8️⃣ Completion Criteria (Backend Ready for Frontend)

The backend login system is considered ready for frontend integration when:

All unit tests pass

All integration tests pass

All API tests pass

No authentication logic exists in frontend

Backend returns stable, documented responses

Authentication behavior is reproducible via tests

9️⃣ Frontend Enablement

Once this ADR is completed:

Frontend can treat backend as an identity oracle

Frontend only handles UX and wallet interaction

No cryptographic or security logic leaks into frontend

Conclusion

This test plan ensures that wallet-based authentication is:

Secure

Testable

Deterministic

Backend-driven

By completing this plan, the backend authentication layer becomes a stable foundation for frontend development and future authorization logic.

ADR-003 — Execution Checklist
1. SignatureService (Unit – Identity)

Test: accepts a valid wallet signature

Test: rejects invalid signature

Test: rejects signature for altered message

Test: rejects signature with mismatched publicKey

Implementation: returns VerifiedSignature

Implementation: throws InvalidSignatureError

2. Challenge Service (Unit – Anti-Replay)

Test: generates unique challenges

Test: challenge has expiration

Test: rejects expired challenge

Test: rejects reused challenge

Test: rejects unknown challenge

Implementation: challenge generation

Implementation: challenge persistence (in-memory for now)

3. JwtService (Unit – Session)

Test: issues JWT for verified identity

Test: JWT contains wallet publicKey

Test: JWT contains iat and exp

Test: rejects expired JWT

Test: rejects malformed JWT

Implementation: token signing

Implementation: token verification

4. LoginService (Unit – Orchestration)

Test: successful login returns JWT

Test: login fails on invalid signature

Test: login fails on invalid challenge

Test: login fails on reused challenge

Implementation: login orchestration

Implementation: error propagation

5. LoginService (Integration – No Mocks)

Integration test: full login flow succeeds

Integration test: invalid signature rejects login

Integration test: replay attack rejected

Integration test: expired challenge rejected

6. Auth API (HTTP Integration)

Test: GET /auth/challenge returns challenge

Test: challenge is unique per request

Test: POST /auth/login returns JWT

Test: invalid signature returns 401

Test: invalid or reused challenge returns 401

Implementation: auth controller

Implementation: request validation

7. Security & Abuse Scenarios

Test: stolen signature replay

Test: altered message attack

Test: wrong publicKey attack

Test: expired JWT usage

Test: missing Authorization header

Test: malformed JWT

8. Backend Readiness for Frontend

All authentication tests passing

No auth logic required in frontend

API behavior documented

Error responses stable and explicit

Backend login flow reproducible via tests

9. Exit Criteria

Backend authentication closed as feature

Frontend can start TDD independently

Roles and authorization explicitly deferred

Final Note

This checklist is authoritative.
A task is considered done only when its test exists and passes.
